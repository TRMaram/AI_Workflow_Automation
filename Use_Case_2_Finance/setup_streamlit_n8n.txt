@echo off
setlocal enabledelayedexpansion

:: Streamlit & n8n Automated Setup Script for Windows
:: This batch script sets up Streamlit and n8n on Windows 10+ systems

:: Show header
echo ==========================================================
echo üöÄ Streamlit ^& n8n Automated Setup Script for Windows
echo üîß Running in current directory mode
echo üî∂ Using local n8n installation (npm) instead of Docker
echo ==========================================================

:: Check if running as administrator
net session >nul 2>&1
if %errorLevel% == 0 (
    echo ‚úÖ Running with administrator privileges.
) else (
    echo ‚ö†Ô∏è This script is not running with administrator privileges.
    echo ‚ö†Ô∏è Some operations may fail. Consider restarting as administrator.
    set /p continueAnyway="üîÑ Continue anyway? (y/n): "
    if /i not "!continueAnyway!"=="y" exit /b
)

:: Check Python installation
echo üìã Checking Python installation...
where python >nul 2>&1
if %errorLevel% == 0 (
    set pythonCommand=python
    goto :pythonFound
)

where python3 >nul 2>&1
if %errorLevel% == 0 (
    set pythonCommand=python3
    goto :pythonFound
)

where py >nul 2>&1
if %errorLevel% == 0 (
    set pythonCommand=py
    goto :pythonFound
)

:: Python not found
echo ‚ùå Python not found.
set /p installChoice="üì• Would you like to install Python now? (y/n): "
if /i "!installChoice!"=="y" (
    echo üì• Opening Python download page...
    start https://www.python.org/downloads/
    echo ‚ÑπÔ∏è Please install Python 3.9-3.11 and make sure to check 'Add Python to PATH'
    echo ‚ÑπÔ∏è After installation, please restart this script.
    exit /b
) else (
    echo ‚ùå Python is required to continue. Exiting script.
    exit /b 1
)

:pythonFound
echo ‚úÖ Python found: %pythonCommand%

:: Check Python version
for /f "tokens=2" %%i in ('%pythonCommand% --version 2^>^&1') do (
    set pythonVersion=%%i
)
echo ‚úÖ Python %pythonVersion% found

:: Check if Python version is compatible (3.9-3.11 recommended for Streamlit)
for /f "tokens=1,2 delims=." %%a in ("!pythonVersion!") do (
    set pythonMajor=%%a
    set pythonMinor=%%b
)

if !pythonMajor! EQU 3 (
    if !pythonMinor! GEQ 9 (
        if !pythonMinor! LEQ 11 (
            echo ‚úÖ Python !pythonVersion! is compatible with Streamlit.
            goto :pythonVersionOk
        )
    )
)

echo ‚ö†Ô∏è Python !pythonVersion! may not be fully compatible with Streamlit.
echo ‚ÑπÔ∏è Recommended version is Python 3.9-3.11.
set /p continueChoice="üîÑ Continue anyway? (y/n): "
if /i not "!continueChoice!"=="y" exit /b

:pythonVersionOk

:: Check pip installation
where pip >nul 2>&1
if %errorLevel% == 0 (
    set pipCommand=pip
    echo ‚úÖ pip is installed.
    goto :pipFound
)

where pip3 >nul 2>&1
if %errorLevel% == 0 (
    set pipCommand=pip3
    echo ‚úÖ pip3 is installed.
    goto :pipFound
)

:: Try to install pip
echo ‚ùå pip is not installed.
echo üì• Attempting to install pip...
%pythonCommand% -m ensurepip

where pip >nul 2>&1
if %errorLevel% == 0 (
    set pipCommand=pip
    echo ‚úÖ pip installed successfully.
    goto :pipFound
)

where pip3 >nul 2>&1
if %errorLevel% == 0 (
    set pipCommand=pip3
    echo ‚úÖ pip installed successfully.
    goto :pipFound
)

:: Try get-pip.py
echo ‚ùå Failed to install pip.
echo üì• Downloading get-pip.py...
curl -o get-pip.py https://bootstrap.pypa.io/get-pip.py
%pythonCommand% get-pip.py

where pip >nul 2>&1
if %errorLevel% == 0 (
    set pipCommand=pip
    echo ‚úÖ pip installed successfully.
    goto :pipFound
)

where pip3 >nul 2>&1
if %errorLevel% == 0 (
    set pipCommand=pip3
    echo ‚úÖ pip installed successfully.
    goto :pipFound
)

echo ‚ùå Failed to install pip. Please install it manually.
exit /b 1

:pipFound

:: Use current directory as project folder
echo üìÇ Using current directory as project folder
set projectFolder=.

set /p streamlitScript="üìÑ Enter the name of your Streamlit script file (e.g., app.py): "
if "!streamlitScript!"=="" (
    set streamlitScript=app.py
    echo ‚ÑπÔ∏è Using default name: !streamlitScript!
)

set /p workflowJson="üìÑ Enter the path to your n8n workflow JSON file (or leave empty if none): "
if not "!workflowJson!"=="" (
    if not exist "!workflowJson!" (
        echo ‚ö†Ô∏è n8n workflow file not found at: !workflowJson!
        set /p continueChoice="üîÑ Continue without workflow file? (y/n): "
        if /i not "!continueChoice!"=="y" exit /b
        set workflowJson=
    )
)

:: Working directory info
echo üìç Working directory: %cd%

:: Check and create virtual environment
echo üîß Setting up Python virtual environment...

:: Check if venv module is available
%pythonCommand% -m venv --help >nul 2>&1
if %errorLevel% == 0 (
    set venvAvailable=1
) else (
    set venvAvailable=0
    echo ‚ùå Python venv module not available.
    echo üì• Attempting to install virtualenv...
    %pipCommand% install virtualenv
    
    where virtualenv >nul 2>&1
    if %errorLevel% NEQ 0 (
        echo ‚ùå Failed to install virtualenv. Please install it manually.
        echo ‚ÑπÔ∏è Run: pip install virtualenv
        exit /b 1
    )
)

:: Create virtual environment
echo üîß Creating Python virtual environment...
if exist venv (
    echo ‚ö†Ô∏è A virtual environment already exists.
    set /p recreateVenv="üîÑ Recreate virtual environment? (y/n): "
    if /i "!recreateVenv!"=="y" (
        rmdir /s /q venv
        if !venvAvailable! EQU 1 (
            %pythonCommand% -m venv venv
        ) else (
            virtualenv venv
        )
        echo ‚úÖ Virtual environment recreated.
    ) else (
        echo ‚úÖ Using existing virtual environment.
    )
) else (
    if !venvAvailable! EQU 1 (
        %pythonCommand% -m venv venv
    ) else (
        virtualenv venv
    )
    
    if %errorLevel% NEQ 0 (
        echo ‚ùå Failed to create virtual environment.
        exit /b 1
    )
    echo ‚úÖ Virtual environment created.
)

:: Activate virtual environment
echo üîå Activating virtual environment...
if exist venv\Scripts\activate.bat (
    call venv\Scripts\activate.bat
    echo ‚úÖ Virtual environment activated.
) else (
    echo ‚ùå Failed to activate virtual environment.
    echo ‚ÑπÔ∏è Try running: venv\Scripts\activate.bat
    exit /b 1
)

:: Create requirements.txt if it doesn't exist
if not exist requirements.txt (
    echo üìù Creating requirements.txt...
    (
        echo streamlit^>=1.24.0
        echo requests^>=2.28.0
        echo pandas^>=1.5.0
    ) > requirements.txt
    echo ‚úÖ Created requirements.txt with basic dependencies
) else (
    echo ‚úÖ Using existing requirements.txt
    
    :: Check if streamlit is in requirements.txt
    findstr /i /c:"streamlit" requirements.txt >nul
    if %errorLevel% NEQ 0 (
        echo ‚ö†Ô∏è Streamlit not found in requirements.txt
        set /p addStreamlit="üì• Add streamlit to requirements.txt? (y/n): "
        if /i "!addStreamlit!"=="y" (
            echo streamlit^>=1.24.0>> requirements.txt
            echo ‚úÖ Added streamlit to requirements.txt
        )
    )
)

:: Install dependencies
echo üì¶ Installing Python dependencies...
%pipCommand% install -r requirements.txt

if %errorLevel% NEQ 0 (
    echo ‚ùå Failed to install dependencies.
    set /p continueChoice="üîÑ Continue anyway? (y/n): "
    if /i not "!continueChoice!"=="y" exit /b
) else (
    echo ‚úÖ Dependencies installed successfully.
    
    :: Verify streamlit installation
    where streamlit >nul 2>&1
    if %errorLevel% NEQ 0 (
        echo ‚ùå Streamlit installation not found in PATH.
        echo ‚ö†Ô∏è You might need to install it manually or restart your terminal.
        set /p installStreamlit="üì• Install streamlit directly? (y/n): "
        if /i "!installStreamlit!"=="y" (
            %pipCommand% install streamlit
            where streamlit >nul 2>&1
            if %errorLevel% EQU 0 (
                echo ‚úÖ Streamlit installed successfully.
            ) else (
                echo ‚ùå Streamlit installation failed.
                exit /b 1
            )
        )
    ) else (
        echo ‚úÖ Streamlit is available.
    )
)

:: Create Streamlit webhook integration if it doesn't exist
if not exist %streamlitScript% (
    echo üìù Creating Streamlit webhook integration script...
    (
        echo import streamlit as st
        echo import requests
        echo import json
        echo import os
        echo.
        echo # Page configuration
        echo st.set_page_config(page_title="n8n Workflow Trigger", page_icon="üîÑ"^)
        echo.
        echo st.title("n8n Workflow Trigger"^)
        echo st.write("Click the button below to trigger your n8n workflow via webhook"^)
        echo.
        echo # Get webhook URL from environment variable or use default
        echo N8N_WEBHOOK_URL = os.environ.get("N8N_WEBHOOK_URL", "http://localhost:5678/webhook/your-webhook-path"^)
        echo.
        echo # Allow user to set the webhook URL in the UI
        echo with st.sidebar:
        echo     st.header("Configuration"^)
        echo     webhook_url = st.text_input("n8n Webhook URL", value=N8N_WEBHOOK_URL^)
        echo     
        echo     if st.button("Save webhook URL", key="save_url"^):
        echo         N8N_WEBHOOK_URL = webhook_url
        echo         st.success("Webhook URL updated!"^)
        echo.
        echo # Function to trigger the webhook
        echo def trigger_n8n_webhook(^):
        echo     try:
        echo         # Get any user input
        echo         with st.expander("Webhook Parameters (Optional^)", expanded=False^):
        echo             param_input = st.text_area("JSON Parameters:", 
        echo                                      value='{\\n  "example": "value"\\n}',
        echo                                      height=150,
        echo                                      help="Add parameters to send to n8n in JSON format"^)
        echo             
        echo             # Parse the JSON parameters
        echo             try:
        echo                 params = json.loads(param_input^)
        echo             except json.JSONDecodeError:
        echo                 st.warning("Invalid JSON. Using empty parameter set."^)
        echo                 params = {}
        echo         
        echo         # Display a spinner while making the request
        echo         with st.spinner("Triggering n8n workflow..."^):
        echo             response = requests.post(webhook_url, json=params^)
        echo         
        echo         # Check if the request was successful
        echo         if response.status_code in [200, 201]:
        echo             st.success(f"Workflow triggered successfully! Status code: {response.status_code}"^)
        echo             
        echo             # Display the response from n8n if there is one
        echo             if response.text:
        echo                 with st.expander("Response details"^):
        echo                     try:
        echo                         st.json(response.json(^)^)
        echo                     except:
        echo                         st.text(response.text^)
        echo         else:
        echo             st.error(f"Failed to trigger workflow. Status code: {response.status_code}"^)
        echo             st.error(f"Response: {response.text}"^)
        echo     
        echo     except requests.exceptions.RequestException as e:
        echo         st.error(f"Error connecting to n8n: {str(e^)}"^)
        echo         st.info("Make sure n8n is running and accessible."^)
        echo     except Exception as e:
        echo         st.error(f"An unexpected error occurred: {str(e^)}"^)
        echo.
        echo # Create a prominent button to trigger the webhook
        echo if st.button("üöÄ Trigger n8n Workflow", type="primary", use_container_width=True^):
        echo     trigger_n8n_webhook(^)
        echo.
        echo # Add some helpful information
        echo with st.expander("How to set up your n8n webhook"^):
        echo     st.markdown("""
        echo     1. In n8n, add a **Webhook node** as a trigger for your workflow
        echo     2. Configure it as a webhook (rather than test webhook^)
        echo     3. Copy the webhook URL from n8n
        echo     4. Paste it in the **n8n Webhook URL** field in the sidebar
        echo     5. Click "Save webhook URL"
        echo     6. Click the "Trigger n8n Workflow" button to execute your workflow
        echo     """^)
        echo.
        echo # Connection status check
        echo with st.sidebar:
        echo     if st.button("Check n8n connection", key="check_connection"^):
        echo         try:
        echo             # Just check if the n8n server is reachable
        echo             base_url = webhook_url.split('/webhook/'^)[0]
        echo             response = requests.get(f"{base_url}/healthz", timeout=5^)
        echo             if response.status_code == 200:
        echo                 st.success(f"‚úÖ n8n server is reachable!"^)
        echo             else:
        echo                 st.warning(f"‚ö†Ô∏è n8n server returned status code: {response.status_code}"^)
        echo         except requests.exceptions.RequestException as e:
        echo             st.error(f"‚ùå Cannot connect to n8n: {str(e^)}"^)
        echo             st.info("Make sure n8n is running at the correct URL."^)
        echo.
        echo # Display the current webhook URL
        echo st.caption(f"Current webhook URL: {webhook_url}"^)
    ) > %streamlitScript%
    echo ‚úÖ Created Streamlit script: %streamlitScript%
) else (
    echo ‚úÖ Using existing Streamlit script: %streamlitScript%
)

:: Check if Node.js is installed for n8n setup
echo üìã Checking for Node.js installation...
where node >nul 2>&1
if %errorLevel% EQU 0 (
    echo ‚úÖ Node.js is installed
    
    :: Check Node.js version
    for /f "tokens=*" %%i in ('node -v') do set nodeVersion=%%i
    echo ‚úÖ Node.js version: !nodeVersion!
    
    :: Check if npm is installed
    where npm >nul 2>&1
    if %errorLevel% EQU 0 (
        echo ‚úÖ npm is installed
        
        :: Check if n8n is already installed
        echo üìã Checking if n8n is installed...
        where n8n >nul 2>&1
        if %errorLevel% EQU 0 (
            echo ‚úÖ n8n is already installed
            for /f "tokens=*" %%i in ('n8n --version') do set n8nVersion=%%i
            echo ‚úÖ n8n version: !n8nVersion!
        ) else (
            echo ‚ùå n8n is not installed
            set /p installN8n="üì• Would you like to install n8n globally? (y/n): "
            if /i "!installN8n!"=="y" (
                echo üì• Installing n8n globally via npm...
                
                net session >nul 2>&1
                if %errorLevel% EQU 0 (
                    npm install n8n -g
                ) else (
                    echo ‚ö†Ô∏è Not running as administrator. You may need to run as admin for global npm installs.
                    set /p installAnyway="üì• Try to install anyway? (y/n): "
                    if /i "!installAnyway!"=="y" (
                        npm install n8n -g
                    ) else (
                        echo ‚ùå n8n installation cancelled.
                        exit /b 1
                    )
                )
                
                where n8n >nul 2>&1
                if %errorLevel% EQU 0 (
                    for /f "tokens=*" %%i in ('n8n --version') do set n8nVersion=%%i
                    echo ‚úÖ n8n installed successfully! Version: !n8nVersion!
                ) else (
                    echo ‚ùå n8n installation failed.
                    echo ‚ÑπÔ∏è You may need higher permissions to install global packages.
                    echo ‚ÑπÔ∏è Try running this script as administrator.
                    exit /b 1
                )
            ) else (
                echo ‚ùå n8n is required for this setup.
                exit /b 1
            )
        )
    ) else (
        echo ‚ùå npm is not installed.
        echo ‚ÑπÔ∏è Your Node.js installation may be incomplete or corrupted.
        exit /b 1
    )
) else (
    echo ‚ùå Node.js is not installed.
    set /p installNode="üì• Install Node.js now? (y/n): "
    if /i "!installNode!"=="y" (
        echo üì• Opening Node.js download page...
        start https://nodejs.org/en/download/
        echo ‚ÑπÔ∏è Please install Node.js LTS version and make sure to check 'Add to PATH'
        echo ‚ÑπÔ∏è After installation, please restart this script.
        exit /b
    ) else (
        echo ‚ùå Node.js is required for n8n. Exiting script.
        exit /b 1
    )
)

:: Create n8n startup script
echo üìù Creating n8n startup script...
(
    echo @echo off
    echo echo üöÄ Starting n8n...
    echo echo ‚ÑπÔ∏è n8n will be available at http://localhost:5678
    echo n8n start
) > start_n8n.bat
echo ‚úÖ Created n8n startup script.

:: Instructions for importing workflow
if not "!workflowJson!"=="" if exist "!workflowJson!" (
    echo üìã n8n workflow found: !workflowJson!
    echo ‚ÑπÔ∏è After n8n starts, import the workflow at http://localhost:5678
    echo ‚ÑπÔ∏è Click the gear icon (top right^) ^> 'Import Workflow'
    echo ‚ÑπÔ∏è Select the file: !workflowJson!
)

:: Create a comprehensive start script
echo üìù Creating comprehensive start script...
(
    echo @echo off
    echo REM Script to start both Streamlit and n8n in the current project directory
    echo set ERRORLEVEL=0
    echo.
    echo echo ========================================================
    echo echo üöÄ Starting Streamlit and n8n
    echo echo ========================================================
    echo.
    echo REM Check if ports are in use
    echo netstat -ano | findstr :8501 >nul
    echo if %%ERRORLEVEL%% EQU 0 (
    echo     echo ‚ö†Ô∏è Port 8501 is already in use. Streamlit may not start correctly.
    echo     choice /C YN /M "üîÑ Continue anyway?"
    echo     if %%ERRORLEVEL%% NEQ 1 goto :EOF
    echo ^)
    echo.
    echo netstat -ano | findstr :5678 >nul
    echo if %%ERRORLEVEL%% EQU 0 (
    echo     echo ‚ö†Ô∏è Port 5678 is already in use. n8n may not start correctly.
    echo     choice /C YN /M "üîÑ Continue anyway?"
    echo     if %%ERRORLEVEL%% NEQ 1 goto :EOF
    echo ^)
    echo.
    echo REM Start n8n in a new window
    echo echo üöÄ Starting n8n...
    echo start "n8n" cmd /c "n8n start"
    echo echo ‚úÖ n8n started in a new window
    echo echo ‚ÑπÔ∏è n8n will be available at http://localhost:5678
    echo.
    echo REM Give n8n time to start
    echo echo ‚è≥ Waiting for n8n to initialize...
    echo timeout /t 10 /nobreak ^> nul
    echo.
    echo REM Activate virtual environment
    echo echo üîå Activating virtual environment...
    echo call venv\Scripts\activate.bat
    echo.
    echo REM Check if Streamlit is installed in the virtual environment
    echo where streamlit ^> nul 2^>^&1
    echo if %%ERRORLEVEL%% NEQ 0 (
    echo     echo ‚ùå Streamlit not found in the virtual environment.
    echo     echo üì• Installing Streamlit...
    echo     pip install streamlit
    echo     if %%ERRORLEVEL%% NEQ 0 (
    echo         echo ‚ùå Failed to install Streamlit. Please install it manually.
    echo         exit /b 1
    echo     ^)
    echo ^)
    echo.
    echo REM Start Streamlit app
    echo echo üöÄ Starting Streamlit app...
    echo echo ‚ÑπÔ∏è Streamlit will be available at: http://localhost:8501
    echo streamlit run %streamlitScript%
    echo.
    echo REM Note: This script doesn't properly handle stopping n8n when Streamlit is stopped
    echo REM If you want to stop n8n, you'll need to close its window manually
) > start_apps.bat

echo ======================================================== 
echo ‚úÖ Setup complete!
echo ========================================================
echo üìã To start your applications:
echo    1. Run: .\start_apps.bat from this directory
echo    - Streamlit will be available at: http://localhost:8501
echo    - n8n will be available at: http://localhost:5678
echo.
echo ‚ÑπÔ∏è Remember to update the N8N_WEBHOOK_URL in your Streamlit app
echo    with the actual webhook URL from your n8n workflow.
echo ========================================================

:: Ask if they want to start the applications now
set /p startNow="üöÄ Do you want to start the applications now? (y/n): "
if /i "!startNow!"=="y" (
    call .\start_apps.bat
) else (
    echo üëã You can start the applications later by running: .\start_apps.bat
)

endlocal
